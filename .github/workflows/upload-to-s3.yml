name: Create deploy-package.zip for CodeDeploy

on:
  push:
    branches:
      - main
  workflow_dispatch:   # ✅ 수동 실행 버튼용

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    env:
      BUCKET_NAME: app-deploy-jp
      OBJECT_KEY: team5-tokyo-build/deploy-package.zip

    steps:
      - name: 📥 Checkout source code
        uses: actions/checkout@v4

      - name: ☕ Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 🔨 Build with Maven
        run: |
          cd project1
          mvn clean package -DskipTests
          cd ..

      - name: 📦 Prepare deploy directory
        run: |
          mkdir -p deploy
          cp appspec.yml deploy/
          cp project1/target/project1.war deploy/
          cp -r scripts deploy/
          chmod +x deploy/scripts/*.sh

      - name: 📁 Zip deploy-package
        run: zip -r deploy-package.zip deploy/

      - name: ☁️ Upload to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-1
        run: |
          aws s3 cp deploy-package.zip s3://${{ env.BUCKET_NAME }}/${{ env.OBJECT_KEY }} --acl private
